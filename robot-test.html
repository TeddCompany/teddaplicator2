
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TeddAplicator2 – Robot Test</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body { font-family:Poppins,sans-serif; background:#0f1a17; color:#e0ffe6; margin:0; padding:20px; }
    h1 { font-family:Orbitron,sans-serif; }
    .controls { margin-bottom:20px; }
    select, input, button { padding:8px; margin-right:10px; border-radius:5px; font-size:1em; }
    #log { background:#162821; padding:10px; height:200px; overflow:auto; margin-top:20px; border-radius:5px; }
    .section { margin-top:20px; }
  </style>
</head>
<body>
  <h1>TeddAplicator2 Robot Test</h1>
  <div class="controls">
    <label>Pair:</label>
    <select id="pair">
      <option value="XAUUSD">XAUUSD</option>
      <option value="BTCUSD">BTCUSD</option>
    </select>
    <label>RSI Period:</label>
    <input type="number" id="rsiPeriod" value="14" style="width:60px" />
    <button onclick="startTest()">Mulai Test Robot</button>
    <button onclick="stopTest()">Stop</button>
  </div>

  <!-- Chart Realtime -->
  <div class="section">
    <div id="chart-container" style="height:400px;"></div>
  </div>

  <!-- Log Output -->
  <div id="log"></div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/technicalindicators/3.0.0/technicalindicators.min.js"></script>
  <script>
    let tvWidget = null;
    function loadChart(pair) {
      if (tvWidget) tvWidget.remove();
      tvWidget = new TradingView.widget({
        "width": "100%", "height": 400,
        "symbol": "OANDA:" + pair,
        "interval": "1", "timezone": "Asia/Jakarta",
        "theme": "dark", "style": "1", "locale": "id",
        "toolbar_bg": "#f1f3f6", "enable_publishing": false,
        "allow_symbol_change": false, "container_id": "chart-container"
      });
    }

    const logEl = document.getElementById('log');
    let testInterval = null;

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      logEl.innerHTML = `[${now}] ${msg}<br>` + logEl.innerHTML;
    }

    async function getPrices(pair) {
      try {
        const sym = pair === 'XAUUSD' ? 'XAU/USD' : 'BTC/USD';
        const res = await fetch(`https://api.twelvedata.com/time_series?symbol=${sym}&interval=1min&apikey=71b4e9263e6443f18d394bdfaf453c21&outputsize=100`);
        const data = await res.json();
        return data.values.map(v => parseFloat(v.close)).reverse();
      } catch (e) {
        log('⚠️ Gagal ambil data ' + pair);
        return [];
      }
    }

    async function startTest() {
      const period = parseInt(document.getElementById('rsiPeriod').value);
      const pair = document.getElementById('pair').value;
      loadChart(pair);
      if (testInterval) clearInterval(testInterval);
      log(`⚙️ Mulai uji ${pair} (RSI ${period})...`);

      testInterval = setInterval(async () => {
        const prices = await getPrices(pair);
        if (prices.length < period) {
          log('❌ Data kurang untuk hitung RSI.');
          return;
        }
        const rsi = technicalindicators.RSI.calculate({ values: prices, period }).slice(-1)[0];
        const price = prices[prices.length -1];
        log(`Harga: ${price}, RSI: ${rsi.toFixed(2)}`);
        if (rsi < 30) log('✅ SIGNAL BUY');
        if (rsi > 70) log('⚠️ SIGNAL SELL');
      }, 60000);

      // jalankan satu kali segera
      clearInterval(testInterval);
      testInterval = setTimeout(startTest, 0);
    }

    function stopTest() {
      clearInterval(testInterval);
      testInterval = null;
      log('⏹️ Test dihentikan');
    }

    // reload chart saat pair berubah
    document.getElementById('pair').addEventListener('change', () => {
      loadChart(document.getElementById('pair').value);
    });

    // inisialisasi chart XAUUSD
    loadChart('XAUUSD');
  </script>
</body>
</html>
